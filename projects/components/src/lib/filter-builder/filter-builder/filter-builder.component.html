@if (_isServer) {
  <ng-content/>
}

<ng-template #itemsTpl let-items>
  <div class="group">
    @for (item of items; track item; let index = $index) {
      @if (_isGroup(item)) {
        <div class="flex items-center group-operations">
          <div class="remove" (click)="removeCondition(index, items)">
            <ng-template [ngTemplateOutlet]="_removeRef.templateRef"></ng-template>
          </div>
          <button [matMenuTriggerFor]="nestedGroupOperationsMenu" class="group-operation">
            {{ getSelectedGroupOperationName(item) }}
          </button>
          <div [matMenuTriggerFor]="addGroupMenu" class="add">
            <ng-template [ngTemplateOutlet]="_addRef.templateRef"
                         [ngTemplateOutletContext]="{ $implicit: item }"></ng-template>
          </div>
          <mat-menu #nestedGroupOperationsMenu>
            @for (groupOperation of groupOperations; track groupOperation.id) {
              <button mat-menu-item (click)="selectGroupOperation(groupOperation, item)">{{ groupOperation.name }}</button>
            }
          </mat-menu>
          <mat-menu #addGroupMenu>
            <button mat-menu-item (click)="addCondition(item)">Add Condition</button>
            <button mat-menu-item (click)="addGroup(item)">Add Group</button>
          </mat-menu>
        </div>
        @if (item['value'].length > 0) {
          <ng-container [ngTemplateOutlet]="itemsTpl" [ngTemplateOutletContext]="{ $implicit: item['value'] }"></ng-container>
        }
      } @else if (_isCondition(item)) {
        <div class="condition">
          <div class="remove" (click)="removeCondition(index, items)">
            <ng-template [ngTemplateOutlet]="_removeRef.templateRef"></ng-template>
          </div>
          <button class="condition-field"
                  [matMenuTriggerFor]="fieldsMenu">{{ getConditionField(item['value'][0]).name }}</button>
          <button class="condition-operation"
                  [matMenuTriggerFor]="operationsMenu">
            <ng-template [ngTemplateOutlet]="getConditionOperation(item['value'][1]).name"></ng-template>
          </button>
          <button class="condition-value">
            <span i18n>&lt;enter a value&gt;</span>
          </button>
        </div>
        <mat-menu #fieldsMenu>
          <div emrMenuOptionGroup [(ngModel)]="item[0]">
            @for (field of fields; track field) {
              <mat-option [value]="field.id" (click)="selectConditionField(item['value'], field)">{{ field.name }}</mat-option>
            }
          </div>
        </mat-menu>
        <mat-menu #operationsMenu>
          <div emrMenuOptionGroup [(ngModel)]="item[1]">
            @for (operation of _operationDefs; track operation) {
              <mat-option [value]="operation.id" (click)="selectConditionOperation(item['value'], operation)">
                <div class="flex items-center">
                  @if (operation.operationIcon) {
                    <ng-template [ngTemplateOutlet]="operation.operationIcon.templateRef"></ng-template>
                  }

                  <ng-template [ngTemplateOutlet]="operation.operationName.templateRef"></ng-template>
                </div>
              </mat-option>
            }
          </div>
        </mat-menu>
      }
    }
  </div>
</ng-template>

<div class="group">
  <div class="flex items-center group-operations">
    <button [matMenuTriggerFor]="groupOperationsMenu" class="group-operation">
      {{ getSelectedGroupOperationName() }}
    </button>
    <div [matMenuTriggerFor]="addMenu" class="add">
      <ng-template [ngTemplateOutlet]="_addRef.templateRef"></ng-template>
    </div>
  </div>
  <ng-container [ngTemplateOutlet]="itemsTpl" [ngTemplateOutletContext]="{ $implicit: _value }"></ng-container>
</div>
<mat-menu #groupOperationsMenu>
  @for (groupOperation of groupOperations; track groupOperation.id) {
    <button mat-menu-item (click)="selectGroupOperation(groupOperation)">{{ groupOperation.name }}</button>
  }
</mat-menu>
<mat-menu #addMenu>
  <button mat-menu-item (click)="addCondition()">Add Condition</button>
  <button mat-menu-item (click)="addGroup()">Add Group</button>
</mat-menu>
